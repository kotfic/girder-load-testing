- name: Make source directory
  file:
    path: "{{ locust_base_dir }}/"
    state: directory
    owner: "{{ remote_ssh_user }}"
    group: "{{ remote_ssh_user }}"
  become: yes
  become_user: root

- name: Copy locust files
  copy:
    src: ../../locust_files/
    dest: "{{ locust_base_dir }}/"
    owner: "{{ remote_ssh_user }}"
    group: "{{ remote_ssh_user }}"

- name: Set generate_data.sh mode
  file:
    path: "{{ locust_base_dir }}/data/generate_data.sh"
    mode: 0755

- name: Generate test data
  shell: >-
    ./generate_data.sh
  args:
    chdir: "{{ locust_base_dir }}/data/"
    creates: "{{ locust_base_dir }}/data/100mb.bin"

- name: Install locust and requirements
  pip:
    requirements: "{{ locust_base_dir }}/requirements.txt"
    executable: pip3
  become: yes
  become_user: root

- name: Install master locust service
  template:
    src: "templates/locust-master.service.j2"
    dest: "/etc/systemd/system/locust-master.service"
  become: yes
  become_user: root

- name: Install slave locust service
  template:
    src: "templates/locust-slave.service.j2"
    dest: "/etc/systemd/system/locust-slave.service"
  become: yes
  become_user: root


- name: Reload Systemd
  systemd:
    name: "locust-master"
    daemon_reload: yes
  become: yes
  become_user: root
